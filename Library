-- KazeAdapter.lua
-- Adapter that provides "tabs" and common elements (Button, Toggle, Slider, Dropdown, TextBox, Section, Paragraph)
-- using the KazeUI window returned by KazeUI:CreateWindow(...)
-- Usage:
--   local KazeUI = require(path.to.KazeUI) -- ModuleScript that returns the KazeUI table
--   local windowHandles = KazeUI:CreateWindow({ Title = "My UI", Author = "You", Icon = "6031763447" })
--   local Adapter = require(path.to.KazeAdapter)
--   local ui = Adapter.new(windowHandles) -- returns an object to create tabs and elements
--   local tab = ui:CreateTab("General")
--   tab:AddSection("Settings")
--   tab:AddToggle({ "Enable X", "Toggle description", function(val) print("toggled", val) end, nil, "flag.enableX" })
--   tab:AddButton({ "Do Thing", "Runs something", function() print("clicked") end })
-- NOTES:
--   - This adapter intentionally does not modify the KazeUI base. It creates children under windowHandles.Content.
--   - Styles are simple and compatible with the existing Kaze UI look.

local Adapter = {}
Adapter.__index = Adapter

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- helper: quick create
local function new(instType, props, parent)
	local obj = Instance.new(instType)
	if props then
		for k, v in pairs(props) do
			pcall(function() obj[k] = v end)
		end
	end
	if parent then
		obj.Parent = parent
	end
	return obj
end

local function clamp(v, a, b) return math.max(a, math.min(b, v)) end

-- default colors (kept neutral so it sits on top of Kaze base)
local THEME = {
	Background = Color3.fromRGB(27, 27, 30),
	Accent = Color3.fromRGB(0, 160, 255),
	Text = Color3.fromRGB(235, 235, 235),
	SubText = Color3.fromRGB(160, 160, 160),
	Stroke = Color3.fromRGB(45, 45, 50)
}

-- Create an adapter bound to a KazeUI window handle table
-- window: table returned from KazeUI:CreateWindow(...) with keys { Window, Content, Icon, MiniButton }
function Adapter.new(window)
	assert(type(window) == "table" and window.Window and window.Content, "Adapter.new expects the KazeUI window handles table")
	local self = setmetatable({}, Adapter)

	self.window = window.Window
	self.content = window.Content
	self.icon = window.Icon
	self.mini = window.MiniButton

	self.Flags = {} -- simple flag storage
	self.Tabs = {}
	self._selectedTab = nil

	-- Build left tab bar and main page container inside content
	local leftWidth = 180

	self.sidebar = new("Frame", {
		Name = "KazeAdapter_Sidebar",
		Size = UDim2.new(0, leftWidth, 1, 0),
		Position = UDim2.new(0, 0, 0, 0),
		BackgroundColor3 = THEME.Background,
		BorderSizePixel = 0,
	}, self.content)
	new("UICorner", { CornerRadius = UDim.new(0, 8) }, self.sidebar)
	local sidebarStroke = new("UIStroke", { Color = THEME.Stroke, Thickness = 1 }, self.sidebar)

	self.tabList = new("ScrollingFrame", {
		Name = "TabList",
		Size = UDim2.new(1, 0, 1, 0),
		BackgroundTransparency = 1,
		ScrollBarThickness = 6,
		AutomaticCanvasSize = Enum.AutomaticSize.Y,
		CanvasSize = UDim2.new(),
	}, self.sidebar)
	local padding = new("UIPadding", {
		PaddingTop = UDim.new(0, 8),
		PaddingBottom = UDim.new(0, 8),
		PaddingLeft = UDim.new(0, 8),
		PaddingRight = UDim.new(0, 8),
	}, self.tabList)
	local layout = new("UIListLayout", { Padding = UDim.new(0, 6) }, self.tabList)

	self.container = new("Frame", {
		Name = "KazeAdapter_Container",
		Size = UDim2.new(1, -leftWidth, 1, 0),
		Position = UDim2.new(0, leftWidth, 0, 0),
		BackgroundTransparency = 1,
	}, self.content)

	-- Select a tab (internal)
	function self:_selectTab(tabObj)
		if not tabObj then return end
		if self._selectedTab == tabObj then return end

		-- hide old
		if self._selectedTab and self._selectedTab.page then
			self._selectedTab.page.Visible = false
			if self._selectedTab.button then
				self._selectedTab.button.BackgroundTransparency = 1
			end
		end

		-- show new
		self._selectedTab = tabObj
		if tabObj.page then
			tabObj.page.Visible = true
			if tabObj.button then
				tabObj.button.BackgroundTransparency = 0
			end
		end
	end

	-- Create Tab: returns a tab object with methods to add elements
	function self:CreateTab(title, icon)
		title = title or "Tab"
		-- Tab button in sidebar
		local btn = new("TextButton", {
			Name = "TabButton_" .. title,
			Size = UDim2.new(1, 0, 0, 34),
			AutoButtonColor = false,
			Text = title,
			TextColor3 = THEME.Text,
			Font = Enum.Font.GothamBold,
			TextSize = 14,
			TextXAlignment = Enum.TextXAlignment.Left,
			BackgroundTransparency = 1,
		}, self.tabList)
		new("UICorner", { CornerRadius = UDim.new(0, 8) }, btn)

		-- page container
		local page = new("ScrollingFrame", {
			Name = "Page_" .. title,
			Size = UDim2.new(1, 0, 1, 0),
			Position = UDim2.new(0, 0, 0, 0),
			BackgroundTransparency = 1,
			ScrollBarThickness = 8,
			AutomaticCanvasSize = Enum.AutomaticSize.Y,
			CanvasSize = UDim2.new(),
			Visible = false,
		}, self.container)
		local pagePadding = new("UIPadding", {
			PaddingTop = UDim.new(0, 12),
			PaddingLeft = UDim.new(0, 12),
			PaddingRight = UDim.new(0, 12),
			PaddingBottom = UDim.new(0, 12),
		}, page)
		local pageLayout = new("UIListLayout", { Padding = UDim.new(0, 8) }, page)

		local tabObj = { title = title, button = btn, page = page }

		btn.MouseButton1Click:Connect(function()
			self:_selectTab(tabObj)
		end)

		-- element helpers

		function tabObj:AddSection(sectionName)
			local frame = new("Frame", {
				Size = UDim2.new(1, 0, 0, 28),
				BackgroundTransparency = 1,
			}, page)
			local label = new("TextLabel", {
				Size = UDim2.new(1, 0, 1, 0),
				BackgroundTransparency = 1,
				Text = sectionName,
				TextColor3 = THEME.Text,
				Font = Enum.Font.GothamBold,
				TextSize = 16,
				TextXAlignment = Enum.TextXAlignment.Left,
			}, frame)
			return {
				Destroy = function() frame:Destroy() end,
				Set = function(new) if new then label.Text = tostring(new) end end,
				Visible = function(b) frame.Visible = (b ~= nil) and b or not frame.Visible end
			}
		end

		function tabObj:AddParagraph(config)
			local title = (type(config) == "table" and config[1]) or (type(config) == "string" and config) or "Paragraph"
			local text = (type(config) == "table" and config[2]) or ""
			local holder = new("Frame", {
				Size = UDim2.new(1, 0, 0, 54),
				BackgroundColor3 = THEME.Stroke,
				BackgroundTransparency = 0.92,
			}, page)
			new("UICorner", { CornerRadius = UDim.new(0, 8) }, holder)
			local titleLbl = new("TextLabel", {
				Size = UDim2.new(1, -16, 0, 18),
				Position = UDim2.fromOffset(8, 6),
				BackgroundTransparency = 1,
				Text = title,
				TextColor3 = THEME.Text,
				Font = Enum.Font.GothamBold,
				TextSize = 14,
				TextXAlignment = Enum.TextXAlignment.Left,
			}, holder)
			local descLbl = new("TextLabel", {
				Size = UDim2.new(1, -16, 0, 24),
				Position = UDim2.fromOffset(8, 26),
				BackgroundTransparency = 1,
				Text = text,
				TextColor3 = THEME.SubText,
				Font = Enum.Font.Gotham,
				TextSize = 12,
				TextWrapped = true,
				TextXAlignment = Enum.TextXAlignment.Left,
			}, holder)
			return {
				Set = function(t1, t2)
					if t1 and t2 then titleLbl.Text = t1; descLbl.Text = t2
					elseif t1 then descLbl.Text = t1 end
				end,
				Destroy = function() holder:Destroy() end,
				Visible = function(b) holder.Visible = (b ~= nil) and b or not holder.Visible end
			}
		end

		function tabObj:AddButton(config)
			local name = (type(config) == "table" and (config[1] or config.Name)) or "Button"
			local desc = (type(config) == "table" and (config.Desc or config.Description)) or ""
			local callback = (type(config) == "table" and config[2]) or (type(config) == "function" and config) or nil

			local container = new("Frame", {
				Size = UDim2.new(1, 0, 0, 36),
				BackgroundTransparency = 1,
			}, page)
			local btn = new("TextButton", {
				Size = UDim2.new(1, 0, 1, 0),
				BackgroundColor3 = THEME.Accent,
				Text = name,
				Font = Enum.Font.GothamBold,
				TextSize = 14,
				TextColor3 = THEME.Text,
				AutoButtonColor = false,
			}, container)
			new("UICorner", { CornerRadius = UDim.new(0, 8) }, btn)
			btn.MouseButton1Click:Connect(function()
				if type(callback) == "function" then
					pcall(callback)
				end
			end)
			return {
				Callback = function(cb) if type(cb) == "function" then callback = cb end end,
				Destroy = function() container:Destroy() end,
				Visible = function(b) container.Visible = (b ~= nil) and b or not container.Visible end
			}
		end

		function tabObj:AddToggle(config)
			-- config: { Title, Description, Callback, DefaultFlag, FlagName }
			local title = (type(config) == "table" and (config[1] or "Toggle")) or "Toggle"
			local desc = (type(config) == "table" and (config[2] or "")) or ""
			local callback = (type(config) == "table" and config[3]) or nil
			local default = (type(config) == "table" and config[4]) or false
			local flagName = (type(config) == "table" and config[5]) or nil

			if flagName and self.Flags then
				-- adapter-level flags are in self.Flags; prefer stored
				default = self.Flags[flagName] ~= nil and self.Flags[flagName] or default
			end

			local container = new("Frame", {
				Size = UDim2.new(1, 0, 0, 34),
				BackgroundTransparency = 1,
			}, page)
			local label = new("TextLabel", {
				Size = UDim2.new(1, -80, 1, 0),
				Position = UDim2.fromOffset(8, 0),
				BackgroundTransparency = 1,
				Text = title,
				TextColor3 = THEME.Text,
				Font = Enum.Font.GothamBold,
				TextSize = 14,
				TextXAlignment = Enum.TextXAlignment.Left,
			}, container)
			local sub = new("TextLabel", {
				Size = UDim2.new(1, -80, 1, 0),
				Position = UDim2.fromOffset(8, 14),
				BackgroundTransparency = 1,
				Text = desc,
				TextColor3 = THEME.SubText,
				Font = Enum.Font.Gotham,
				TextSize = 12,
				TextXAlignment = Enum.TextXAlignment.Left,
			}, container)

			local toggleFrame = new("Frame", {
				Size = UDim2.new(0, 48, 0, 24),
				Position = UDim2.new(1, -56, 0.5, -12),
				BackgroundColor3 = THEME.Stroke,
			}, container)
			new("UICorner", { CornerRadius = UDim.new(0, 12) }, toggleFrame)
			local knob = new("Frame", {
				Size = UDim2.new(0, 20, 0, 20),
				Position = UDim2.new(0, 4, 0, 2),
				BackgroundColor3 = Color3.fromRGB(240, 240, 240),
			}, toggleFrame)
			new("UICorner", { CornerRadius = UDim.new(1, 0) }, knob)

			local state = default
			local function applyState(st, animate)
				state = st
				if flagName then self.Flags[flagName] = state end
				if animate then
					local newPos = state and UDim2.new(1, -24, 0, 2) or UDim2.new(0, 4, 0, 2)
					knob:TweenPosition(newPos, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.18, true)
				else
					knob.Position = state and UDim2.new(1, -24, 0, 2) or UDim2.new(0, 4, 0, 2)
				end
				if type(callback) == "function" then
					pcall(callback, state)
				end
			end
			toggleFrame.MouseButton1Click = toggleFrame.MouseButton1Click or Instance.new("BindableEvent") -- avoid errors on non-TextButton
			toggleFrame.InputBegan:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
					applyState(not state, true)
				end
			end)

			applyState(state, false)

			return {
				Set = function(val) if type(val) == "boolean" then applyState(val, true) end end,
				Callback = function(cb) if type(cb) == "function" then callback = cb end end,
				Destroy = function() container:Destroy() end,
				Visible = function(b) container.Visible = (b ~= nil) and b or not container.Visible end
			}
		end

		function tabObj:AddSlider(config)
			-- config: { Title, Min, Max, Step, Callback, Default }
			local title = (type(config) == "table" and (config[1] or "Slider")) or "Slider"
			local min = (type(config) == "table" and (config[2] or 0)) or 0
			local max = (type(config) == "table" and (config[3] or 100)) or 100
			local step = (type(config) == "table" and (config[4] or 1)) or 1
			local callback = (type(config) == "table" and config[5]) or nil
			local default = (type(config) == "table" and config[6]) or ((min + max) / 2)

			local container = new("Frame", {
				Size = UDim2.new(1, 0, 0, 44),
				BackgroundTransparency = 1,
			}, page)
			local titleLbl = new("TextLabel", {
				Size = UDim2.new(1, -12, 0, 16),
				Position = UDim2.fromOffset(6, 0),
				BackgroundTransparency = 1,
				Text = title,
				TextColor3 = THEME.Text,
				Font = Enum.Font.GothamBold,
				TextSize = 13,
				TextXAlignment = Enum.TextXAlignment.Left,
			}, container)

			local bar = new("Frame", {
				Size = UDim2.new(1, -12, 0, 10),
				Position = UDim2.fromOffset(6, 22),
				BackgroundColor3 = THEME.Stroke,
			}, container)
			new("UICorner", { CornerRadius = UDim.new(0, 6) }, bar)
			local fill = new("Frame", {
				Size = UDim2.new(0, 0, 1, 0),
				BackgroundColor3 = THEME.Accent,
			}, bar)
			new("UICorner", { CornerRadius = UDim.new(0, 6) }, fill)
			local knob = new("ImageButton", {
				Size = UDim2.new(0, 14, 0, 14),
				Position = UDim2.new(0, -7, 0.5, -7),
				BackgroundColor3 = Color3.fromRGB(245,245,245),
				AutoButtonColor = false,
				Image = "",
			}, bar)
			new("UICorner", { CornerRadius = UDim.new(1, 0) }, knob)

			local value = default
			local function updateFromX(x)
				local abs = bar.AbsoluteSize.X
				local rel = clamp(x - bar.AbsolutePosition.X, 0, abs)
				local t = rel / abs
				local raw = min + t * (max - min)
				-- quantize to step
				local quant = math.floor((raw / step) + 0.5) * step
				value = clamp(quant, min, max)
				local percent = (value - min) / (max - min)
				fill.Size = UDim2.new(percent, 0, 1, 0)
				knob.Position = UDim2.new(percent, -7, 0.5, -7)
				if type(callback) == "function" then pcall(callback, value) end
			end

			local dragging = false
			knob.InputBegan:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
					dragging = true
				end
			end)
			knob.InputEnded:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
					dragging = false
				end
			end)
			UIS.InputChanged:Connect(function(input)
				if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
					updateFromX(input.Position.X)
				end
			end)
			bar.InputBegan:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
					updateFromX(input.Position.X)
				end
			end)

			-- initialize
			updateFromX(bar.AbsolutePosition.X + (bar.AbsoluteSize.X * ((default - min) / (max - min))))

			return {
				Set = function(v)
					if type(v) == "number" then
						value = clamp(v, min, max)
						local percent = (value - min) / (max - min)
						fill.Size = UDim2.new(percent, 0, 1, 0)
						knob.Position = UDim2.new(percent, -7, 0.5, -7)
					end
				end,
				Callback = function(cb) if type(cb) == "function" then callback = cb end end,
				Destroy = function() container:Destroy() end,
				Visible = function(b) container.Visible = (b ~= nil) and b or not container.Visible end
			}
		end

		function tabObj:AddDropdown(config)
			-- config: { Title, OptionsTable, Callback, Default }
			local title = (type(config) == "table" and (config[1] or "Dropdown")) or "Dropdown"
			local options = (type(config) == "table" and (config[2] or {})) or {}
			local callback = (type(config) == "table" and config[3]) or nil
			local default = (type(config) == "table" and config[4]) or nil

			local container = new("Frame", {
				Size = UDim2.new(1, 0, 0, 36),
				BackgroundTransparency = 1,
			}, page)
			local titleLbl = new("TextLabel", {
				Size = UDim2.new(1, -12, 0, 16),
				Position = UDim2.fromOffset(6, 0),
				BackgroundTransparency = 1,
				Text = title,
				TextColor3 = THEME.Text,
				Font = Enum.Font.GothamBold,
				TextSize = 13,
				TextXAlignment = Enum.TextXAlignment.Left,
			}, container)

			local selector = new("TextButton", {
				Size = UDim2.new(1, -12, 0, 20),
				Position = UDim2.fromOffset(6, 16),
				BackgroundColor3 = THEME.Stroke,
				Text = tostring(default or "Select..."),
				TextColor3 = THEME.Text,
				Font = Enum.Font.Gotham,
				TextSize = 13,
				AutoButtonColor = false,
			}, container)
			new("UICorner", { CornerRadius = UDim.new(0, 6) }, selector)

			local drop = new("Frame", {
				Size = UDim2.new(0, 160, 0, 0),
				Position = UDim2.new(0, 6, 0, 56),
				BackgroundColor3 = THEME.Background,
				Visible = false,
				BorderSizePixel = 0,
			}, container)
			new("UICorner", { CornerRadius = UDim.new(0, 8) }, drop)
			local dropLayout = new("UIListLayout", { Padding = UDim.new(0, 4) }, drop)
			local dropPad = new("UIPadding", { PaddingTop = UDim.new(0, 6), PaddingBottom = UDim.new(0, 6), PaddingLeft = UDim.new(0, 6), PaddingRight = UDim.new(0, 6) }, drop)

			local function rebuild()
				for _,c in pairs(drop:GetChildren()) do
					if c:IsA("TextButton") then c:Destroy() end
				end
				local h = 6
				for i, opt in ipairs(options) do
					local btn = new("TextButton", {
						Size = UDim2.new(1, 0, 0, 26),
						BackgroundColor3 = THEME.Stroke,
						Text = tostring(opt),
						TextColor3 = THEME.Text,
						Font = Enum.Font.Gotham,
						TextSize = 13,
						AutoButtonColor = false,
					}, drop)
					btn.MouseButton1Click:Connect(function()
						selector.Text = tostring(opt)
						drop.Visible = false
						if type(callback) == "function" then pcall(callback, opt) end
					end)
					h = h + 30
				end
				drop.Size = UDim2.new(0, 160, 0, math.clamp(h, 0, 240))
				drop.Position = UDim2.new(0, 6, 0, 56)
			end

			selector.MouseButton1Click:Connect(function()
				drop.Visible = not drop.Visible
			end)

			rebuild()

			return {
				SetOptions = function(tbl) if type(tbl) == "table" then options = tbl; rebuild() end end,
				Callback = function(cb) if type(cb) == "function" then callback = cb end end,
				Destroy = function() container:Destroy() end,
				Visible = function(b) container.Visible = (b ~= nil) and b or not container.Visible end
			}
		end

		function tabObj:AddTextBox(config)
			-- config: { Title, DefaultText, Callback, Placeholder }
			local title = (type(config) == "table" and (config[1] or "TextBox")) or "TextBox"
			local default = (type(config) == "table" and (config[2] or "")) or ""
			local callback = (type(config) == "table" and config[3]) or nil
			local placeholder = (type(config) == "table" and config[4]) or "Input..."

			local container = new("Frame", {
				Size = UDim2.new(1, 0, 0, 48),
				BackgroundTransparency = 1,
			}, page)
			local titleLbl = new("TextLabel", {
				Size = UDim2.new(1, -12, 0, 16),
				Position = UDim2.fromOffset(6, 0),
				BackgroundTransparency = 1,
				Text = title,
				TextColor3 = THEME.Text,
				Font = Enum.Font.GothamBold,
				TextSize = 13,
				TextXAlignment = Enum.TextXAlignment.Left,
			}, container)

			local box = new("TextBox", {
				Size = UDim2.new(1, -12, 0, 24),
				Position = UDim2.fromOffset(6, 20),
				BackgroundColor3 = THEME.Stroke,
				Text = default,
				TextColor3 = THEME.Text,
				Font = Enum.Font.Gotham,
				TextSize = 14,
				ClearTextOnFocus = false,
				PlaceholderText = placeholder,
			}, container)
			new("UICorner", { CornerRadius = UDim.new(0, 6) }, box)

			box.FocusLost:Connect(function(enter)
				if type(callback) == "function" then
					pcall(callback, box.Text)
				end
			end)

			return {
				Set = function(t) box.Text = tostring(t) end,
				OnChange = function(cb) if type(cb) == "function" then box:GetPropertyChangedSignal("Text"):Connect(function() pcall(cb, box.Text) end) end end,
				Destroy = function() container:Destroy() end,
				Visible = function(b) container.Visible = (b ~= nil) and b or not container.Visible end
			}
		end

		-- done building tab
		table.insert(self.Tabs, tabObj)

		-- if this is the first tab, auto-select
		if #self.Tabs == 1 then
			self:_selectTab(tabObj)
		end

		return tabObj
	end

	return self
end

return Adapter
